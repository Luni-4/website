<!DOCTYPE html>
<html lang="en">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <link rel="apple-touch-icon" sizes="120x120" href="https://rav1e.rs/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://rav1e.rs/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://rav1e.rs/favicon-16x16.png">
    <link rel="manifest" href="https://rav1e.rs/manifest.json">
    <link rel="mask-icon" href="https://rav1e.rs/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="theme-color" content="#ffffff">

    
    <link rel="stylesheet" href="https://rav1e.rs/css/bootstrap-reboot.css">
    <link rel="stylesheet" href="https://rav1e.rs/css/bootstrap.css">
    <link rel="stylesheet" href="https://rav1e.rs/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://rav1e.rs/css/rav1e.css">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css"/>

    
    <link rel="alternate" type="application/rss+xml" href="https://tokio.rs/blog/index.xml" />

    <title>
      
        Implementing futures - rav1e
      
    </title>
  </head>
  <body>
    <header class="navbar navbar-expand navbar-dark flex-column flex-md-row tk-navbar">
      <a class="navbar-brand" href="https://rav1e.rs/">
        <img src="https://rav1e.rs/img/logo.png" class="align-middle" alt="">
      </a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link " href="https://rav1e.rs/">Home</a>
          </li>
          <li class="nav-item">
            
            
            
            <a class="nav-link  active " href="https://rav1e.rs/docs/getting-started/hello-world/">Documentation</a>
          </li>
          <li class="nav-item">
            
            <a class="nav-link " href="https://rav1e.rs/community/">Community</a>
          </li>
          <li class="nav-item">
            
            
            <a class="nav-link " href="https://rav1e.rs/blog/2018-12-recap-2018/">Blog</a>
          </li>
        </ul>
      </div>

      <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
        <li class="nav-item">
          <a class="nav-link p-2" href="https://github.com/xiph/rav1e" target="_blank" rel="noopener" aria-label="GitHub">
            <svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 512 499.36" focusable="false"><title>GitHub</title><path d="M256 0C114.64 0 0 114.61 0 256c0 113.09 73.34 209 175.08 242.9 12.8 2.35 17.47-5.56 17.47-12.34 0-6.08-.22-22.18-.35-43.54-71.2 15.49-86.2-34.34-86.2-34.34-11.64-29.57-28.42-37.45-28.42-37.45-23.27-15.84 1.73-15.55 1.73-15.55 25.69 1.81 39.21 26.38 39.21 26.38 22.84 39.12 59.92 27.82 74.5 21.27 2.33-16.54 8.94-27.82 16.25-34.22-56.84-6.43-116.6-28.43-116.6-126.49 0-27.95 10-50.8 26.35-68.69-2.63-6.48-11.42-32.5 2.51-67.75 0 0 21.49-6.88 70.4 26.24a242.65 242.65 0 0 1 128.18 0c48.87-33.13 70.33-26.24 70.33-26.24 14 35.25 5.18 61.27 2.55 67.75 16.41 17.9 26.31 40.75 26.31 68.69 0 98.35-59.85 120-116.88 126.32 9.19 7.9 17.38 23.53 17.38 47.41 0 34.22-.31 61.83-.31 70.23 0 6.85 4.61 14.81 17.6 12.31C438.72 464.97 512 369.08 512 256.02 512 114.62 397.37 0 256 0z" fill="currentColor" fill-rule="evenodd"/></svg>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link p-2" href="https://gitter.im/tokio-rs/tokio" target="_blank" rel="noopener" aria-label="Gitter">
            <svg class="navbar-nav-svg" xmlns="http://www.w3.org/2000/svg" focusable="false"><title>Gitter</title><path fill="currentColor" d="M8.501 4.001H10.5V24H8.501V4.001zm6.999 0V24h-2V4.001h2zM3.5 0h2.001v15H3.5V0zm15 4.001h2V15h-2V4.001z"/></svg>
          </a>
        </li>
      </ul>
    </header>



<div class="container-fluid tk-docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 tk-sidebar">
      <form class="tk-search d-flex align-items-center">
        <span class="algolia-autocomplete algolia-autocomplete-left" style="position: relative; display: inline-block; direction: ltr;">
          <input class="form-control ds-input" id="search-input" placeholder="Search..." autocomplete="off" spellcheck="false" role="combobox" aria-autocomplete="list" aria-expanded="false" aria-owns="algolia-autocomplete-listbox-0" style="position: relative; vertical-align: top;" dir="auto" type="search">
          <pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, &quot;Helvetica Neue&quot;, Arial, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-size: 16px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: normal; text-indent: 0px; text-rendering: optimizelegibility; text-transform: none;">w</pre>
          <span class="ds-dropdown-menu ds-with-1" style="position: absolute; top: 100%; left: 0px; z-index: 100; right: auto; display: none;" role="listbox" id="algolia-autocomplete-listbox-0">
            <div class="ds-dataset-1"></div>
          </span>
        </span>
        <button class="btn btn-link tk-search-docs-toggle d-md-none p-0 ml-3" type="button" data-toggle="collapse" data-target="#tk-docs-nav" aria-controls="tk-docs-nav" aria-expanded="false" aria-label="Toggle docs navigation"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false">
            <title>Menu</title><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"></path></svg>
        </button>
      </form>

      <nav class="tk-links collapse" id="tk-docs-nav">
          
          
            
              <div class="tk-toc-item">
                <a class="tk-toc-link" href="https://rav1e.rs/docs/overview/">
                  What is Tokio?
                </a>
              </div>
            
          
            
              
              <div class="tk-toc-item ">
                <a class="tk-toc-link" href="https://rav1e.rs/docs/getting-started/hello-world/">
                  Getting started
                </a>
                <ul class="nav tk-sidenav">
                
                  <li><a href="https://rav1e.rs/docs/getting-started/hello-world/" class="">Hello World!</a></li>
                
                  <li><a href="https://rav1e.rs/docs/getting-started/futures/" class="">Futures</a></li>
                
                  <li><a href="https://rav1e.rs/docs/getting-started/runtime/" class="">Runtime</a></li>
                
                  <li><a href="https://rav1e.rs/docs/getting-started/echo/" class="">Example: An Echo Server</a></li>
                
                </ul>
              </div>
            
          
            
              
              <div class="tk-toc-item active">
                <a class="tk-toc-link" href="https://rav1e.rs/docs/futures/overview/">
                  Working with futures
                </a>
                <ul class="nav tk-sidenav">
                
                  <li><a href="https://rav1e.rs/docs/futures/overview/" class="">Overview</a></li>
                
                  <li><a href="https://rav1e.rs/docs/futures/basic/" class="active">Implementing futures</a></li>
                
                  <li><a href="https://rav1e.rs/docs/futures/getting_asynchronous/" class="">Getting asynchronous</a></li>
                
                  <li><a href="https://rav1e.rs/docs/futures/combinators/" class="">Combinators</a></li>
                
                  <li><a href="https://rav1e.rs/docs/futures/streams/" class="">Streams</a></li>
                
                  <li><a href="https://rav1e.rs/docs/futures/spawning/" class="">Spawning</a></li>
                
                  <li><a href="https://rav1e.rs/docs/futures/leaf-futures/" class="">Leaf futures</a></li>
                
                  <li><a href="https://rav1e.rs/docs/futures/runtime-model/" class="">Runtime model</a></li>
                
                </ul>
              </div>
            
          
            
              
              <div class="tk-toc-item ">
                <a class="tk-toc-link" href="https://rav1e.rs/docs/io/overview/">
                  I/O with Tokio
                </a>
                <ul class="nav tk-sidenav">
                
                  <li><a href="https://rav1e.rs/docs/io/overview/" class="">I/O Overview</a></li>
                
                  <li><a href="https://rav1e.rs/docs/io/reading_writing_data/" class="">Reading and Writing Data</a></li>
                
                  <li><a href="https://rav1e.rs/docs/io/async_read_write/" class="">Using AsyncRead and AsyncWrite directly</a></li>
                
                  <li><a href="https://rav1e.rs/docs/io/impl_async_read_write/" class="">Implementing Async Read/Write</a></li>
                
                  <li><a href="https://rav1e.rs/docs/io/filesystem/" class="">Filesystem APIs</a></li>
                
                  <li><a href="https://rav1e.rs/docs/io/datagrams/" class="">Datagram APIs</a></li>
                
                </ul>
              </div>
            
          
            
              
              <div class="tk-toc-item ">
                <a class="tk-toc-link" href="https://rav1e.rs/docs/going-deeper/futures/">
                  Going deeper
                </a>
                <ul class="nav tk-sidenav">
                
                  <li><a href="https://rav1e.rs/docs/going-deeper/futures/" class="">Futures: In Depth</a></li>
                
                  <li><a href="https://rav1e.rs/docs/going-deeper/tasks/" class="">Tasks</a></li>
                
                  <li><a href="https://rav1e.rs/docs/going-deeper/runtime-model/" class="">Runtime Model</a></li>
                
                  <li><a href="https://rav1e.rs/docs/going-deeper/io/" class="">I/O with Tokio</a></li>
                
                  <li><a href="https://rav1e.rs/docs/going-deeper/chat/" class="">Example: A Chat Server</a></li>
                
                  <li><a href="https://rav1e.rs/docs/going-deeper/timers/" class="">Timers</a></li>
                
                  <li><a href="https://rav1e.rs/docs/going-deeper/futures-mechanics/" class="">Essential combinators</a></li>
                
                  <li><a href="https://rav1e.rs/docs/going-deeper/returning/" class="">Returning futures</a></li>
                
                  <li><a href="https://rav1e.rs/docs/going-deeper/frames/" class="">Working with framed streams</a></li>
                
                  <li><a href="https://rav1e.rs/docs/going-deeper/building-runtime/" class="">Building a runtime</a></li>
                
                </ul>
              </div>
            
          
            
              
              <div class="tk-toc-item ">
                <a class="tk-toc-link" href="https://rav1e.rs/docs/internals/intro/">
                  Tokio internals
                </a>
                <ul class="nav tk-sidenav">
                
                  <li><a href="https://rav1e.rs/docs/internals/intro/" class="">Introduction</a></li>
                
                  <li><a href="https://rav1e.rs/docs/internals/runtime-model/" class="">Runtime model</a></li>
                
                  <li><a href="https://rav1e.rs/docs/internals/net/" class="">Non-blocking I/O</a></li>
                
                </ul>
              </div>
            
          
            
              <div class="tk-toc-item">
                <a class="tk-toc-link" href="https://docs.rs/tokio">
                  API documentation
                </a>
              </div>
            
          
      </nav>
    </div>
    <div class="d-none d-xl-block col-xl-2 tk-toc">
      <div class="section-nav">
        <nav id="TableOfContents">
<ul>
<li><a href="#the-future-trait">The <code>Future</code> trait.</a></li>
<li><a href="#running-the-future">Running the future</a></li>
<li><a href="#cleaning-things-up">Cleaning things up</a></li>
</ul>
</nav>
      </div>
    </div>
    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 tk-content tk-docs">
      <h1 class="tk-title">Implementing futures</h1>
      <div class="github-edit">
        <a class="fa fa-github" href="https://github.com/tokio-rs/website/tree/master/content/docs/futures/basic.md"> Edit on GitHub</a>
      </div>
      

<p>Implementing futures is very common when using Tokio. Let&rsquo;s start with a very
basic future that performs no asynchronous logic and simply returns a message
(the venerable &ldquo;hello world&rdquo;).</p>

<h1 id="the-future-trait">The <code>Future</code> trait.</h1>

<p>The <code>Future</code> trait is as follows:</p>

<pre><code class="language-rust,ignore">trait Future {
    /// The type of the value returned when the future completes.
    type Item;

    /// The type representing errors that occurred while processing the computation.
    type Error;

    /// The function that will be repeatedly called to see if the future
    /// has completed or not. The `Async` enum can either be `Ready` or
    /// `NotReady` and indicates whether the future is ready to produce
    /// a value or not.
    fn poll(&amp;mut self) -&gt; Result&lt;Async&lt;Self::Item&gt;, Self::Error&gt;;
}
</code></pre>

<p>Let&rsquo;s implement it for our &ldquo;hello world&rdquo; future:</p>

<pre><code class="language-rust"># #![deny(deprecated)]
extern crate futures;

// `Poll` is a type alias for `Result&lt;Async&lt;T&gt;, E&gt;`
use futures::{Future, Async, Poll};

struct HelloWorld;

impl Future for HelloWorld {
    type Item = String;
    type Error = ();

    fn poll(&amp;mut self) -&gt; Poll&lt;Self::Item, Self::Error&gt; {
        Ok(Async::Ready(&quot;hello world&quot;.to_string()))
    }
}

# fn main() {}
</code></pre>

<p>The <code>Item</code> and <code>Error</code> associated types define the types returned by the future
once it completes. <code>Item</code> is the success value and <code>Error</code> is returned when the
future encounters an error while processing. By convention, infallible futures
set <code>Error</code> to <code>()</code>.</p>

<p>Futures use a poll based model. The consumer of a future repeatedly calls the
<code>poll</code> function. The future then attempts to complete. If the future is able to
complete, it returns <code>Async::Ready(value)</code>. If the future is unable to complete
due to being blocked on an internal resource (such as a TCP socket), it returns
<code>Async::NotReady</code>.</p>

<p>When a future&rsquo;s <code>poll</code> function is called, the implementation will
<strong>synchronously</strong> do as much work as possible until it is logically
blocked on some asynchronous event that has not occured yet. The future
implementation then saves its state internally so that the next time
<code>poll</code> is called (after an external event is received), it resumes
processing from the point it left off. Work is not repeated.</p>

<p>The hello world future requires no asynchronous processing and is immediately
ready, so it returns <code>Ok(Async::Ready(value))</code>.</p>

<h1 id="running-the-future">Running the future</h1>

<p>Tokio is responsible for running futures to completion. This is done by passing
the future to <code>tokio::run</code>.</p>

<p>The <code>tokio::run</code> accepts futures where both <code>Item</code> and <code>Error</code> are set to <code>()</code>.
This is because Tokio only executes the futures, it does not do anything with
values. The user of Tokio is required to fully process all values in the future.</p>

<p>In our case, let&rsquo;s print the future to STDOUT. We will do that by implementing a
<code>Display</code> future.</p>

<pre><code class="language-rust"># #![deny(deprecated)]
extern crate futures;

use futures::{Future, Async, Poll};
use std::fmt;

struct Display&lt;T&gt;(T);

impl&lt;T&gt; Future for Display&lt;T&gt;
where
    T: Future,
    T::Item: fmt::Display,
{
    type Item = ();
    type Error = T::Error;

    fn poll(&amp;mut self) -&gt; Poll&lt;(), T::Error&gt; {
        let value = match self.0.poll() {
            Ok(Async::Ready(value)) =&gt; value,
            Ok(Async::NotReady) =&gt; return Ok(Async::NotReady),
            Err(err) =&gt; return Err(err),
        };

        println!(&quot;{}&quot;, value);
        Ok(Async::Ready(()))
    }
}

# fn main() {}
</code></pre>

<p>The <code>Display</code> takes a future that yields items that can be displayed. When it is
polled, it first tries to poll the inner future. If the inner future is <strong>not
ready</strong> then <code>Display</code> cannot complete. In this case, <code>Display</code> also returns
<code>NotReady</code>.</p>

<p><strong><code>poll</code> implementations must never return <code>NotReady</code> unless they received
<code>NotReady</code> by calling an inner future.</strong> This will be explained in more detail
in a later section.</p>

<p>The <code>Display</code> future will error when the inner future errors. The error is
bubbled up.</p>

<p>When <code>HelloWorld</code> is combined with <code>Display</code>, both the <code>Item</code> and <code>Error</code> types
are <code>()</code> and the future can be executed by Tokio:</p>

<pre><code class="language-rust"># #![deny(deprecated)]
extern crate tokio;
# extern crate futures;
# struct HelloWorld;
# struct Display&lt;T&gt;(T);
# impl&lt;T&gt; futures::Future for Display&lt;T&gt; {
#     type Item = ();
#     type Error = ();
#     fn poll(&amp;mut self) -&gt; futures::Poll&lt;(), ()&gt; {
#         Ok(().into())
#     }
# }

# fn main() {
let future = Display(HelloWorld);
tokio::run(future);
# }
</code></pre>

<p>Running this results in &ldquo;hello world&rdquo; being outputted to standard out.</p>

<h1 id="cleaning-things-up">Cleaning things up</h1>

<p>The pattern of waiting on an inner future is common enough that there is a
helper macro: <code>try_ready!</code>.</p>

<p>The poll function can be rewritten using the macro as such:</p>

<pre><code class="language-rust"># #![deny(deprecated)]
#[macro_use]
extern crate futures;

use futures::{Future, Async, Poll};
use std::fmt;

struct Display&lt;T&gt;(T);

impl&lt;T&gt; Future for Display&lt;T&gt;
where
    T: Future,
    T::Item: fmt::Display,
{
    type Item = ();
    type Error = T::Error;

    fn poll(&amp;mut self) -&gt; Poll&lt;(), T::Error&gt; {
        let value = try_ready!(self.0.poll());
        println!(&quot;{}&quot;, value);
        Ok(Async::Ready(()))
    }
}

# fn main() {}
</code></pre>

      
      
        <div class="tk-next">
          <b>Next up</b>: <a href ="/docs/futures/getting_asynchronous/">Getting asynchronous</a>
        </div>
      
    </main>
  </div>
</div>

    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js" integrity="sha384-3ceskX3iaEnIogmQchP8opvBy3Mi7Ce34nWjpBIwVTHfGYWQS9jwHDVRnpKKHJg7" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.7/js/tether.min.js" integrity="sha384-XTs3FgkjiBgo8qjEjBk0tGmf3wPrWtA6coPfQDfFEY8AnYJwjalXCiosYRBIBZX8" crossorigin="anonymous"></script>
    <script src="https://rav1e.rs/js/bootstrap.min.js"></script>
    <script src="https://rav1e.rs/js/highlight.js"></script>
    <script>
      $(function () {
        $("pre code").each(function(i, block) {
          
          if (block.className.indexOf('language-rust') >= 0) {
            var new_content = '';
            var lines = block.textContent.split('\n');
            for (var i = 0; i < lines.length; i++) {
              if (lines[i].indexOf('# ') == 0 || lines[i] == '#') {
                continue
              }
              new_content += lines[i].trimRight() + '\n';
            }
            block.textContent = new_content.replace(/\n\n\n/g, "\n\n").trimRight();
          }
          hljs.highlightBlock(block);
        });
      });
    </script>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script type="text/javascript"> docsearch({
    apiKey: 'd7b5b785798fe748621bcaa8301a2201',
    indexName: 'tokio',
    inputSelector: '#search-input',
    debug: false 
    });
    </script>
    
  </body>
</html>

